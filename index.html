<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>Генератор Mini App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- Подключаем Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --tg-theme-bg-color: #ffffff;
            --tg-theme-text-color: #000000;
            --tg-theme-hint-color: #999999;
            --tg-theme-link-color: #2481cc;
            --tg-theme-button-color: #2481cc;
            --tg-theme-button-text-color: #ffffff;
            --tg-theme-secondary-bg-color: #f4f4f4;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overscroll-behavior: none;
            -webkit-tap-highlight-color: transparent;
            margin: 0;
        }
        #app-container { background: var(--tg-theme-secondary-bg-color); }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes popIn { 0% { opacity: 0; transform: scale(0.8); } 80% { opacity: 1; transform: scale(1.05); } 100% { opacity: 1; transform: scale(1); } }
        .animate-in { animation: fadeInUp 0.5s cubic-bezier(0.4, 0, 0.2, 1) both; }
        .step {
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.4s;
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--tg-theme-bg-color);
            visibility: hidden;
        }
        .step.active { transform: translateX(0); opacity: 1; visibility: visible; }
        .step.hidden-right { transform: translateX(100%); opacity: 0; }
        .step.hidden-left { transform: translateX(-100%); opacity: 0; }
        .template-list-item {
            border: 2px solid transparent;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            transition: all 0.25s ease-in-out;
        }
        .template-list-item:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.08); }
        .template-list-item.selected {
            border-color: var(--tg-theme-button-color);
            background-color: color-mix(in srgb, var(--tg-theme-button-color) 8%, transparent);
            transform: translateY(-2px) scale(1.01);
        }
        .template-list-item.selected .chevron { color: var(--tg-theme-button-color); transform: translateX(2px); }
        .chevron { transition: color 0.2s, transform 0.2s; }
        .category-tab { transition: all 0.25s; border-bottom: 3px solid transparent; padding-bottom: 10px; white-space: nowrap; }
        .category-tab.active { color: var(--tg-theme-link-color); border-bottom-color: var(--tg-theme-link-color); }
        #template-list::-webkit-scrollbar, #category-tabs::-webkit-scrollbar { display: none; }
        #template-list, #category-tabs { -ms-overflow-style: none; scrollbar-width: none; }
        input[type="file"] { display: none; }
        .custom-file-upload { border: 2px dashed var(--tg-theme-hint-color); transition: border-color 0.2s, background-color 0.2s; }
        .custom-file-upload.dragover { border-color: var(--tg-theme-button-color); background-color: color-mix(in srgb, var(--tg-theme-button-color) 10%, transparent); }
        .mockup-phone { background: #1c1c1e; border-radius: 44px; padding: 12px; box-shadow: 0 20px 50px -10px rgba(0,0,0,0.25); width: 250px; height: 500px; transition: transform 0.3s; }
        .mockup-screen { background-color: var(--tg-theme-bg-color); border-radius: 32px; overflow: hidden; }
        .mockup-header { background-color: var(--tg-theme-secondary-bg-color); padding: 10px 14px; }
        .mockup-logo { width: 32px; height: 32px; border-radius: 9px; background-color: var(--tg-theme-hint-color); object-fit: cover; display: flex; align-items: center; justify-content: center; font-size: 16px; font-weight: 600; color: var(--tg-theme-text-color); }
        .mockup-title { font-weight: 600; font-size: 14px; }
        .mockup-content { font-size: 12px; }
        #final-success-container { animation: popIn 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) both; }
        .success-checkmark-bg { background-color: color-mix(in srgb, var(--tg-theme-button-color) 15%, transparent); color: var(--tg-theme-button-color); }
        #download-app-btn {
            background-color: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
            transition: all 0.2s ease-in-out;
        }
        #download-app-btn:hover {
            transform: scale(1.03);
            box-shadow: 0 8px 25px -5px var(--tg-theme-button-color);
        }
    </style>
</head>
<body class="overflow-hidden">

    <div id="app-container" class="h-screen w-screen relative max-w-md mx-auto overflow-hidden">

        <!-- Экран 1: Выбор шаблона -->
        <div id="step-1" class="step active flex flex-col h-full">
            <div class="pt-5 shrink-0">
                <div class="text-center mb-4 px-5 animate-in" style="animation-delay: 0.1s;">
                    <h1 class="text-2xl font-bold">Создать Mini App</h1>
                    <p class="text-base text-[var(--tg-theme-hint-color)] mt-1">Шаг 1: Выберите шаблон</p>
                </div>
                <div id="category-tabs" class="flex space-x-6 border-b border-[var(--tg-theme-secondary-bg-color)] mb-2 overflow-x-auto px-5 animate-in" style="animation-delay: 0.2s;"></div>
            </div>
            <div id="template-list" class="flex flex-col gap-3 overflow-y-auto flex-grow p-4 animate-in" style="animation-delay: 0.3s;">
                <!-- Индикатор загрузки -->
                <div id="loading-indicator" class="text-center text-[var(--tg-theme-hint-color)] p-8">Загрузка шаблонов...</div>
            </div>
        </div>

        <!-- Экран 2: Кастомизация -->
        <div id="step-2" class="step hidden-right flex flex-col h-full p-5 overflow-y-auto pb-24">
            <div class="text-center mb-5 shrink-0 animate-in" style="animation-delay: 0.1s;">
                <h1 class="text-2xl font-bold">Настройки</h1>
                <p class="text-base text-[var(--tg-theme-hint-color)] mt-1">Шаг 2: Укажите детали</p>
            </div>
            <div class="flex justify-center mb-6 shrink-0 animate-in" style="animation-delay: 0.2s;">
                <div class="mockup-phone">
                    <div class="mockup-screen h-full flex flex-col">
                        <div class="mockup-header flex items-center space-x-2.5">
                            <div id="mockup-logo-container" class="mockup-logo">
                                <img id="mockup-logo-img" src="" class="w-full h-full object-cover rounded-[9px] hidden">
                                <span id="mockup-logo-initials"></span>
                            </div>
                            <span id="mockup-title-text" class="mockup-title text-[var(--tg-theme-text-color)] whitespace-nowrap overflow-hidden text-ellipsis">Ваше приложение</span>
                        </div>
                        <div id="mockup-content-preview" class="mockup-content flex-grow p-3 text-[var(--tg-theme-hint-color)]">Предпросмотр...</div>
                    </div>
                </div>
            </div>
            <div class="space-y-4">
                <div class="animate-in" style="animation-delay: 0.3s;">
                    <label for="app-name" class="font-semibold text-base block mb-1.5">Название</label>
                    <input type="text" id="app-name" class="w-full p-3 text-sm rounded-xl bg-[var(--tg-theme-secondary-bg-color)] border-2 border-transparent focus:ring-2 focus:ring-[var(--tg-theme-button-color)] focus:bg-[var(--tg-theme-bg-color)] transition outline-none" placeholder="Например, 'Мой Магазин'">
                </div>
                <div class="animate-in" style="animation-delay: 0.4s;">
                    <div class="flex justify-between items-center mb-1.5">
                        <label class="font-semibold text-base">Логотип</label>
                        <button id="remove-logo-btn" class="text-xs text-[var(--tg-theme-link-color)] hidden font-medium">Удалить</button>
                    </div>
                    <label for="logo-upload" id="logo-dropzone" class="custom-file-upload relative h-32 rounded-xl p-4 text-center cursor-pointer flex items-center justify-center">
                        <div id="logo-placeholder" class="flex flex-col items-center justify-center h-full text-[var(--tg-theme-hint-color)]">
                            <svg class="h-8 w-8" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 16.5V9.75m0 0l-3 3m3-3l3 3M6.75 19.5a4.5 4.5 0 01-1.41-8.775 5.25 5.25 0 0110.233-2.33 3 3 0 013.758 3.848A3.752 3.752 0 0118 19.5H6.75z" /></svg>
                            <p class="mt-2 text-xs font-medium">Нажмите или перетащите файл</p>
                        </div>
                        <img id="logo-preview" class="hidden h-full w-auto object-contain rounded-lg" alt="Предпросмотр логотипа">
                    </label>
                    <input id="logo-upload" type="file" accept="image/png, image/jpeg, image/webp">
                </div>
            </div>
        </div>

        <!-- Экран 3: Успех -->
        <div id="step-3" class="step hidden-right flex flex-col h-full items-center justify-center text-center p-6">
            <div id="final-success-container" class="flex flex-col items-center">
                <div class="p-3 rounded-full success-checkmark-bg mb-4">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg>
                </div>
                <h1 class="text-2xl font-bold mb-1.5">Ваш Mini App готов!</h1>
                <p class="text-[var(--tg-theme-hint-color)] mb-6 text-base max-w-sm">Нажмите кнопку ниже, чтобы скачать готовый <b class="font-bold text-[var(--tg-theme-text-color)]">.html</b> файл.</p>
                <a id="download-app-btn" href="#" download="mini-app.html" class="w-full max-w-xs text-center font-semibold py-3 px-5 rounded-xl shadow-lg text-sm">
                    Скачать Mini App
                </a>
            </div>
        </div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // ВАШИ ДАННЫЕ SUPABASE
            const SUPABASE_URL = 'https://jvapdhhyjbianlyfwobm.supabase.co'; 
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp2YXBkaGh5amJpYW5seWZ3b2JtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUzOTMxMTEsImV4cCI6MjA3MDk2OTExMX0.XcvGzp18BeA5Sf-_k7nHaZG5J5eB9H9adQEl3ZAa5mY';

            // ИСПРАВЛЕНИЕ: Используем `supabase` (глобальный объект) для создания клиента
            // и сохраняем его в новую переменную `supabaseClient`.
            const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

            const App = {
                state: { currentStep: 1, selectedTemplate: null, appName: '', logoDataUrl: null },
                DOM: {},
                templatesData: {
                    "Все": [],
                },

                async init() {
                    if (!window.Telegram || !window.Telegram.WebApp) {
                        console.warn("Telegram Web App SDK not found.");
                        window.Telegram = { WebApp: {
                            ready: ()=>{}, expand: ()=>{}, onEvent: ()=>{}, HapticFeedback: { impactOccurred: ()=>{} },
                            MainButton: { setText: ()=>{return this}, show: ()=>{return this}, hide: ()=>{return this}, enable: ()=>{return this}, showProgress: ()=>{}, hideProgress: ()=>{} },
                            BackButton: { show: ()=>{}, hide: ()=>{} },
                            showAlert: (msg) => alert(msg),
                            close: () => console.log("WebApp closed.")
                        }};
                    }
                    this.tg = window.Telegram.WebApp;
                    this.cacheDOM();
                    await this.fetchTemplates();
                    this.prepareTemplates();
                    this.setupTelegram();
                    this.bindEvents();
                    this.renderCategories();
                    this.renderTemplates();
                    this.animateStepChildren(this.DOM.steps[0]);
                },

                async fetchTemplates() {
                    const loadingIndicator = document.getElementById('loading-indicator');
                    try {
                        // ИСПРАВЛЕНИЕ: Используем `supabaseClient` для запроса.
                        const { data, error } = await supabaseClient
                            .from('mini_app_templates')
                            .select('template_id, name, icon, category, preview_html, html_content');
                        if (error) throw error;
                        this.templatesData["Все"] = data.map(item => ({...item, id: item.template_id}));
                        loadingIndicator.style.display = 'none';
                    } catch (error) {
                        console.error("Ошибка при загрузке шаблонов:", error);
                        loadingIndicator.textContent = 'Не удалось загрузить шаблоны.';
                    }
                },

                cacheDOM() {
                    const D = this.DOM;
                    D.steps = document.querySelectorAll('.step');
                    D.categoryTabsContainer = document.getElementById('category-tabs');
                    D.templateListContainer = document.getElementById('template-list');
                    D.appNameInput = document.getElementById('app-name');
                    D.logoUpload = document.getElementById('logo-upload');
                    D.logoDropzone = document.getElementById('logo-dropzone');
                    D.logoPreview = document.getElementById('logo-preview');
                    D.logoPlaceholder = document.getElementById('logo-placeholder');
                    D.removeLogoBtn = document.getElementById('remove-logo-btn');
                    D.mockupLogoImg = document.getElementById('mockup-logo-img');
                    D.mockupLogoInitials = document.getElementById('mockup-logo-initials');
                    D.mockupTitle = document.getElementById('mockup-title-text');
                    D.mockupContentPreview = document.getElementById('mockup-content-preview');
                    D.downloadAppBtn = document.getElementById('download-app-btn');
                },
                
                prepareTemplates() {
                    const categories = [...new Set(this.templatesData["Все"].map(t => t.category))];
                    categories.forEach(cat => { this.templatesData[cat] = []; });
                    this.templatesData["Все"].forEach(t => { 
                        if(this.templatesData[t.category]) this.templatesData[t.category].push(t);
                    });
                },

                setupTelegram() {
                    this.tg.ready();
                    this.tg.expand();
                    const root = document.documentElement;
                    const themeParams = this.tg.themeParams;
                    if (themeParams) {
                        Object.entries(themeParams).forEach(([key, value]) => {
                            root.style.setProperty(`--tg-theme-${key.replace(/_/g, '-')}`, value);
                        });
                    }
                    this.tg.MainButton.setText("Далее").hide();
                    this.tg.BackButton.hide();
                    this.tg.onEvent('mainButtonClicked', this.onMainButtonClick.bind(this));
                    this.tg.onEvent('backButtonClicked', this.onBackButtonClick.bind(this));
                },

                bindEvents() {
                    this.DOM.appNameInput.addEventListener('input', this.updatePreview.bind(this));
                    this.DOM.logoUpload.addEventListener('change', this.handleLogoChange.bind(this));
                    this.DOM.removeLogoBtn.addEventListener('click', this.removeLogo.bind(this));
                    const dropzone = this.DOM.logoDropzone;
                    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => dropzone.addEventListener(eventName, e => { e.preventDefault(); e.stopPropagation(); }));
                    dropzone.addEventListener('dragover', () => dropzone.classList.add('dragover'));
                    dropzone.addEventListener('dragleave', () => dropzone.classList.remove('dragover'));
                    dropzone.addEventListener('drop', e => {
                        dropzone.classList.remove('dragover');
                        if (e.dataTransfer.files && e.dataTransfer.files[0]) {
                            this.DOM.logoUpload.files = e.dataTransfer.files;
                            this.handleLogoChange({ target: this.DOM.logoUpload });
                        }
                    });
                },

                renderCategories() {
                    this.DOM.categoryTabsContainer.innerHTML = '';
                    Object.keys(this.templatesData).forEach((category, index) => {
                        if (this.templatesData[category].length === 0 && category !== "Все") return;
                        const tab = document.createElement('button');
                        tab.className = 'category-tab py-2 px-1 text-sm font-semibold text-[var(--tg-theme-hint-color)]';
                        if (index === 0) tab.classList.add('active');
                        tab.textContent = category;
                        tab.addEventListener('click', () => {
                            this.hapticFeedback('light');
                            document.querySelectorAll('.category-tab').forEach(t => t.classList.remove('active'));
                            tab.classList.add('active');
                            this.renderTemplates(category);
                        });
                        this.DOM.categoryTabsContainer.appendChild(tab);
                    });
                },

                renderTemplates(category = "Все") {
                    this.DOM.templateListContainer.innerHTML = '';
                    if (!this.templatesData[category] || this.templatesData[category].length === 0) {
                        if (this.templatesData["Все"].length === 0) {
                             document.getElementById('loading-indicator').style.display = 'block';
                        }
                        return;
                    }
                    this.templatesData[category].forEach(template => {
                        const listItem = document.createElement('div');
                        listItem.className = 'template-list-item bg-[var(--tg-theme-bg-color)] rounded-xl p-3 flex items-center justify-between w-full cursor-pointer';
                        if (this.state.selectedTemplate === template.id) listItem.classList.add('selected');
                        listItem.dataset.templateId = template.id;
                        listItem.innerHTML = `<div class="flex items-center"><div class="text-2xl w-10 text-center mr-3">${template.icon}</div><div><span class="font-semibold text-sm text-[var(--tg-theme-text-color)]">${template.name}</span><span class="text-xs text-[var(--tg-theme-hint-color)] block">${template.category}</span></div></div><svg class="chevron h-5 w-5 text-[var(--tg-theme-hint-color)]" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="3" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" /></svg>`;
                        listItem.addEventListener('click', () => this.selectTemplate(template.id, listItem));
                        this.DOM.templateListContainer.appendChild(listItem);
                    });
                },

                selectTemplate(templateId, listItemElement) {
                    this.hapticFeedback('light');
                    const isDeselecting = this.state.selectedTemplate === templateId;
                    this.state.selectedTemplate = isDeselecting ? null : templateId;
                    document.querySelectorAll('.template-list-item').forEach(c => c.classList.remove('selected'));
                    if (!isDeselecting) listItemElement.classList.add('selected');
                    this.updateTgButtons();
                },

                handleLogoChange(event) {
                    const file = event.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            this.state.logoDataUrl = e.target.result;
                            this.DOM.logoPreview.src = this.state.logoDataUrl;
                            this.DOM.logoPreview.classList.remove('hidden');
                            this.DOM.logoPlaceholder.classList.add('hidden');
                            this.DOM.removeLogoBtn.classList.remove('hidden');
                            this.updatePreview();
                        };
                        reader.readAsDataURL(file);
                    }
                },

                removeLogo() {
                    this.hapticFeedback('light');
                    this.state.logoDataUrl = null;
                    this.DOM.logoUpload.value = '';
                    this.DOM.logoPreview.src = '';
                    this.DOM.logoPreview.classList.add('hidden');
                    this.DOM.logoPlaceholder.classList.remove('hidden');
                    this.DOM.removeLogoBtn.classList.add('hidden');
                    this.updatePreview();
                },

                updatePreview() {
                    const appName = this.DOM.appNameInput.value.trim();
                    this.state.appName = appName;
                    this.DOM.mockupTitle.textContent = appName || 'Ваше приложение';
                    if (this.state.logoDataUrl) {
                        this.DOM.mockupLogoImg.src = this.state.logoDataUrl;
                        this.DOM.mockupLogoImg.classList.remove('hidden');
                        this.DOM.mockupLogoInitials.classList.add('hidden');
                    } else {
                        this.DOM.mockupLogoImg.classList.add('hidden');
                        this.DOM.mockupLogoInitials.classList.remove('hidden');
                        const initials = (appName.split(' ').map(s => s[0]).join('') || '?').substring(0, 2).toUpperCase();
                        this.DOM.mockupLogoInitials.textContent = initials;
                    }
                    const template = this.templatesData["Все"].find(t => t.id === this.state.selectedTemplate);
                    this.DOM.mockupContentPreview.innerHTML = (template && template.preview_html) ? template.preview_html : 'Предпросмотр...';
                },

                animateStepChildren(stepEl) {
                    const elements = stepEl.querySelectorAll('.animate-in');
                    elements.forEach(el => {
                        el.style.opacity = '0';
                        setTimeout(() => el.style.opacity = '1', 50);
                    });
                },

                showStep(stepNumber, direction = 'forward') {
                    const currentStepEl = document.getElementById(`step-${this.state.currentStep}`);
                    const nextStepEl = document.getElementById(`step-${stepNumber}`);
                    if (!currentStepEl || !nextStepEl) return;
                    currentStepEl.classList.remove('active');
                    nextStepEl.classList.remove('hidden-left', 'hidden-right');
                    currentStepEl.classList.add(direction === 'forward' ? 'hidden-left' : 'hidden-right');
                    nextStepEl.classList.add('active');
                    this.animateStepChildren(nextStepEl);
                    this.state.currentStep = stepNumber;
                    this.updateTgButtons();
                },

                updateTgButtons() {
                    switch (this.state.currentStep) {
                        case 1:
                            this.tg.BackButton.hide();
                            this.state.selectedTemplate ? this.tg.MainButton.setText("Далее").show() : this.tg.MainButton.hide();
                            break;
                        case 2:
                            this.tg.BackButton.show();
                            this.tg.MainButton.setText("Создать").show().enable();
                            break;
                        case 3:
                            this.tg.BackButton.hide();
                            this.tg.MainButton.setText("Скачать и закрыть").show().enable();
                            break;
                    }
                },

                onMainButtonClick() {
                    this.hapticFeedback('medium');
                    switch (this.state.currentStep) {
                        case 1:
                            if (this.state.selectedTemplate) { this.showStep(2); this.updatePreview(); }
                            break;
                        case 2:
                            if (!this.state.appName) { this.tg.showAlert('Пожалуйста, введите название приложения.'); this.hapticFeedback('error'); return; }
                            this.tg.MainButton.showProgress();
                            setTimeout(() => {
                                this.tg.MainButton.hideProgress();
                                this.finalizeApp();
                                this.showStep(3);
                            }, 800);
                            break;
                        case 3:
                            this.DOM.downloadAppBtn.click();
                            setTimeout(() => { this.tg.close(); }, 500);
                            break;
                    }
                },

                onBackButtonClick() {
                    this.hapticFeedback('light');
                    if (this.state.currentStep === 2) this.showStep(1, 'backward');
                },

                finalizeApp() {
                    const template = this.templatesData["Все"].find(t => t.id === this.state.selectedTemplate);
                    if (!template) return;

                    let finalLogoBase64 = this.state.logoDataUrl;
                    if (!finalLogoBase64) {
                        const canvas = document.createElement('canvas');
                        canvas.width = 128; canvas.height = 128;
                        const ctx = canvas.getContext('2d');
                        ctx.fillStyle = this.tg.themeParams.secondary_bg_color || '#f4f4f4';
                        ctx.fillRect(0, 0, 128, 128);
                        ctx.font = 'bold 52px Inter, sans-serif';
                        ctx.fillStyle = this.tg.themeParams.text_color || '#000000';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.fillText(this.DOM.mockupLogoInitials.textContent, 64, 64);
                        finalLogoBase64 = canvas.toDataURL();
                    }
                    
                    let finalHtml = template.html_content
                        .replace(/%%APP_NAME%%/g, this.state.appName)
                        .replace(/%%APP_LOGO_BASE64%%/g, finalLogoBase64)
                        .replace(/%%THEME_PARAMS_JSON%%/g, JSON.stringify(this.tg.themeParams));

                    const blob = new Blob([finalHtml], { type: 'text/html' });
                    const url = URL.createObjectURL(blob);
                    const filename = `${this.state.appName.replace(/[^a-z0-9]/gi, '_').toLowerCase() || 'mini-app'}.html`;
                    this.DOM.downloadAppBtn.href = url;
                    this.DOM.downloadAppBtn.download = filename;
                },

                hapticFeedback(style) {
                    try { this.tg.HapticFeedback.impactOccurred(style); } catch (e) { /* ignore */ }
                }
            };
            App.init();
        });
    </script>
</body>
</html>
