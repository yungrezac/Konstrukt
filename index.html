<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>Генератор Mini App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --tg-theme-bg-color: #ffffff;
            --tg-theme-text-color: #000000;
            --tg-theme-hint-color: #999999;
            --tg-theme-link-color: #2481cc;
            --tg-theme-button-color: #2481cc;
            --tg-theme-button-text-color: #ffffff;
            --tg-theme-secondary-bg-color: #f4f4f4;
        }
        body { font-family: 'Inter', sans-serif; margin: 0; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        #app-container { background: var(--tg-theme-secondary-bg-color); }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes popIn { 0% { opacity: 0; transform: scale(0.8); } 80% { opacity: 1; transform: scale(1.05); } 100% { opacity: 1; transform: scale(1); } }
        .animate-in { animation: fadeInUp 0.5s cubic-bezier(0.4, 0, 0.2, 1) both; }
        .step {
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.4s;
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--tg-theme-bg-color);
            visibility: hidden;
        }
        .step.active { transform: translateX(0); opacity: 1; visibility: visible; }
        .step.hidden-right { transform: translateX(100%); opacity: 0; }
        .step.hidden-left { transform: translateX(-100%); opacity: 0; }
        .template-list-item { border: 2px solid transparent; box-shadow: 0 4px 15px rgba(0,0,0,0.05); transition: all 0.25s ease-in-out; }
        .template-list-item:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.08); }
        .template-list-item.selected { border-color: var(--tg-theme-button-color); background-color: color-mix(in srgb, var(--tg-theme-button-color) 8%, transparent); transform: translateY(-2px) scale(1.01); }
        .template-list-item.selected .chevron { color: var(--tg-theme-button-color); transform: translateX(2px); }
        .chevron { transition: color 0.2s, transform 0.2s; }
        .category-tab { transition: all 0.25s; border-bottom: 3px solid transparent; padding-bottom: 10px; white-space: nowrap; }
        .category-tab.active { color: var(--tg-theme-link-color); border-bottom-color: var(--tg-theme-link-color); }
        #template-list::-webkit-scrollbar, #category-tabs::-webkit-scrollbar { display: none; }
        .scroll-container { -ms-overflow-style: none; scrollbar-width: none; }
        .mockup-phone { background: #1c1c1e; border-radius: 44px; padding: 12px; box-shadow: 0 20px 50px -10px rgba(0,0,0,0.25); width: 250px; height: 500px; transition: transform 0.3s; }
        .mockup-screen { background-color: var(--tg-theme-bg-color); border-radius: 32px; overflow: hidden; }
        .mockup-header { background-color: var(--tg-theme-secondary-bg-color); padding: 10px 14px; }
        .mockup-logo { width: 32px; height: 32px; border-radius: 9px; background-color: var(--tg-theme-hint-color); object-fit: cover; display: flex; align-items: center; justify-content: center; font-size: 16px; font-weight: 600; color: var(--tg-theme-text-color); }
        .mockup-title { font-weight: 600; font-size: 14px; }
        .mockup-content { font-size: 12px; }
        .final-container { animation: popIn 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) both; }
        .final-icon-bg { background-color: color-mix(in srgb, var(--tg-theme-button-color) 15%, transparent); color: var(--tg-theme-button-color); }
        .url-container { background-color: var(--tg-theme-secondary-bg-color); }
        .copy-btn { background-color: var(--tg-theme-button-color); color: var(--tg-theme-button-text-color); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useMemo } = React;

        // --- Supabase Client ---
        const SUPABASE_URL = 'https://jvapdhhyjbianlyfwobm.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp2YXBkaGh5amJpYW5seWZ3b2JtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUzOTMxMTEsImV4cCI6MjA3MDk2OTExMX0.XcvGzp18BeA5Sf-_k7nHaZG5J5eB9H9adQEl3ZAa5mY';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        const tg = window.Telegram.WebApp;

        // --- Main App Component ---
        function App() {
            const [step, setStep] = useState(1);
            const [prevStep, setPrevStep] = useState(1);
            const [templates, setTemplates] = useState([]);
            const [isLoading, setIsLoading] = useState(true);
            const [error, setError] = useState(null);
            const [appConfig, setAppConfig] = useState({
                templateId: null,
                appName: '',
                logoDataUrl: null,
            });
            const [deployedUrl, setDeployedUrl] = useState(null);
            const [isDeploying, setIsDeploying] = useState(false);
            const [deployError, setDeployError] = useState(null);

            const navigateTo = (nextStep) => {
                setPrevStep(step);
                setStep(nextStep);
            };

            useEffect(() => {
                tg.ready();
                tg.expand();
                const themeParams = tg.themeParams;
                if (themeParams && Object.keys(themeParams).length) {
                    Object.entries(themeParams).forEach(([key, value]) => {
                        document.documentElement.style.setProperty(`--tg-theme-${key.replace(/_/g, '-')}`, value);
                    });
                } else {
                    // Fallback for desktop testing
                    const fallbacks = { bg_color: '#ffffff', text_color: '#000000', hint_color: '#999999', link_color: '#2481cc', button_color: '#2481cc', button_text_color: '#ffffff', secondary_bg_color: '#f4f4f4' };
                    Object.entries(fallbacks).forEach(([key, value]) => {
                        document.documentElement.style.setProperty(`--tg-theme-${key.replace(/_/g, '-')}`, value);
                    });
                }
                fetchTemplates();
            }, []);

            const handleMainButtonClick = useCallback(async () => {
                tg.HapticFeedback.impactOccurred('medium');
                if (step === 1 && appConfig.templateId) {
                    navigateTo(2);
                } else if (step === 2) {
                    if (!appConfig.appName) {
                        tg.showAlert('Пожалуйста, введите название приложения.');
                        tg.HapticFeedback.notificationOccurred('error');
                        return;
                    }
                    navigateTo(3);
                    setIsDeploying(true);
                    setDeployError(null);
                    tg.MainButton.showProgress();
                    
                    const result = await deployApp();
                    if (result.url) {
                        setDeployedUrl(result.url);
                    } else {
                        setDeployError(result.error);
                    }
                    setIsDeploying(false);
                    tg.MainButton.hideProgress();
                } else if (step === 3) {
                    tg.close();
                }
            }, [step, appConfig]);

            const handleBackButtonClick = useCallback(() => {
                tg.HapticFeedback.impactOccurred('light');
                if (step === 2) navigateTo(1);
                if (step === 3) {
                    navigateTo(2);
                    setDeployedUrl(null);
                    setDeployError(null);
                }
            }, [step]);

            useEffect(() => {
                tg.onEvent('mainButtonClicked', handleMainButtonClick);
                tg.onEvent('backButtonClicked', handleBackButtonClick);
                return () => {
                    tg.offEvent('mainButtonClicked', handleMainButtonClick);
                    tg.offEvent('backButtonClicked', handleBackButtonClick);
                };
            }, [handleMainButtonClick, handleBackButtonClick]);
            
            useEffect(() => {
                if (step === 1) {
                    tg.BackButton.hide();
                    appConfig.templateId ? tg.MainButton.setText("Далее").show() : tg.MainButton.hide();
                } else if (step === 2) {
                    tg.BackButton.show();
                    tg.MainButton.setText("Опубликовать").show();
                } else if (step === 3) {
                    if (isDeploying) {
                        tg.MainButton.hide();
                        tg.BackButton.hide();
                    } else if (deployedUrl) {
                        tg.BackButton.hide();
                        tg.MainButton.setText("Закрыть").show();
                    } else if (deployError) {
                        tg.BackButton.show();
                        tg.MainButton.setText("Попробовать снова").hide(); // Let user go back manually
                    }
                }
            }, [step, appConfig.templateId, isDeploying, deployedUrl, deployError]);

            const fetchTemplates = async () => {
                setIsLoading(true);
                setError(null);
                try {
                    const { data, error } = await supabaseClient.from('mini_app_templates').select('*');
                    if (error) throw error;
                    setTemplates(data.map(item => ({...item, id: item.template_id})));
                } catch (err) {
                    setError('Не удалось загрузить шаблоны.');
                } finally {
                    setIsLoading(false);
                }
            };
            
            const deployApp = async () => {
                 const template = templates.find(t => t.id === appConfig.templateId);
                if (!template) return { error: "Шаблон не найден." };

                let finalLogoBase64 = appConfig.logoDataUrl;
                if (!finalLogoBase64) {
                    const canvas = document.createElement('canvas');
                    canvas.width = 128; canvas.height = 128;
                    const ctx = canvas.getContext('2d');
                    ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--tg-theme-secondary-bg-color');
                    ctx.fillRect(0, 0, 128, 128);
                    ctx.font = 'bold 52px Inter, sans-serif';
                    ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--tg-theme-text-color');
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    const initials = (appConfig.appName.split(' ').map(s => s[0]).join('') || '?').substring(0, 2).toUpperCase();
                    ctx.fillText(initials, 64, 64);
                    finalLogoBase64 = canvas.toDataURL();
                }

                const finalHtml = template.html_content
                    .replace(/%%APP_NAME%%/g, appConfig.appName)
                    .replace(/%%APP_LOGO_BASE64%%/g, finalLogoBase64)
                    .replace(/%%THEME_PARAMS_JSON%%/g, JSON.stringify(tg.themeParams));
                
                try {
                    const { data, error } = await supabaseClient.functions.invoke('deploy-netlify', {
                        body: { htmlContent: finalHtml, appName: appConfig.appName },
                    });
                    if (error) throw error;
                    if (data.error) throw new Error(data.error);
                    if (!data || !data.url) throw new Error("Функция не вернула URL.");
                    return { url: data.url };
                } catch (err) {
                    return { error: err.message };
                }
            };

            return (
                <div id="app-container" className="h-screen w-screen relative max-w-md mx-auto overflow-hidden">
                    <Step1 isVisible={step === 1} direction={step > prevStep} templates={templates} isLoading={isLoading} error={error} appConfig={appConfig} setAppConfig={setAppConfig} />
                    <Step2 isVisible={step === 2} direction={step > prevStep} appConfig={appConfig} setAppConfig={setAppConfig} templates={templates} />
                    <Step3 isVisible={step === 3} isDeploying={isDeploying} deployedUrl={deployedUrl} error={deployError} />
                </div>
            );
        }

        function StepWrapper({ isVisible, direction, children }) {
            const getClassName = () => {
                if (isVisible) return 'active';
                return direction ? 'hidden-left' : 'hidden-right';
            };
            return <div className={`step ${getClassName()}`}>{children}</div>;
        }

        function Step1({ isVisible, direction, templates, isLoading, error, appConfig, setAppConfig }) {
            const categories = useMemo(() => ["Все", ...new Set(templates.map(t => t.category))], [templates]);
            const [activeCategory, setActiveCategory] = useState("Все");
            const filteredTemplates = useMemo(() => activeCategory === "Все" ? templates : templates.filter(t => t.category === activeCategory), [templates, activeCategory]);

            const handleSelectTemplate = (templateId) => {
                setAppConfig(prev => ({...prev, templateId: prev.templateId === templateId ? null : templateId}));
                tg.HapticFeedback.impactOccurred('light');
            };

            return (
                <StepWrapper isVisible={isVisible} direction={direction}>
                    <div className="flex flex-col h-full">
                        <div className="pt-5 shrink-0">
                            <div className="text-center mb-4 px-5 animate-in">
                                <h1 className="text-2xl font-bold">Создать Mini App</h1>
                                <p className="text-base text-[var(--tg-theme-hint-color)] mt-1">Шаг 1: Выберите шаблон</p>
                            </div>
                            <div className="flex space-x-6 border-b border-[var(--tg-theme-secondary-bg-color)] mb-2 overflow-x-auto px-5 scroll-container animate-in" style={{animationDelay: '0.1s'}}>
                                {categories.map(cat => (
                                    <button key={cat} onClick={() => setActiveCategory(cat)} className={`category-tab py-2 px-1 text-sm font-semibold ${activeCategory === cat ? 'active' : 'text-[var(--tg-theme-hint-color)]'}`}>
                                        {cat}
                                    </button>
                                ))}
                            </div>
                        </div>
                        <div className="flex flex-col gap-3 overflow-y-auto flex-grow p-4 scroll-container animate-in" style={{animationDelay: '0.2s'}}>
                            {isLoading && <div className="text-center text-[var(--tg-theme-hint-color)] p-8">Загрузка шаблонов...</div>}
                            {error && <div className="text-center text-red-500 p-8">{error}</div>}
                            {filteredTemplates.map(template => (
                                <div key={template.id} onClick={() => handleSelectTemplate(template.id)} className={`template-list-item bg-[var(--tg-theme-bg-color)] rounded-xl p-3 flex items-center justify-between w-full cursor-pointer ${appConfig.templateId === template.id ? 'selected' : ''}`}>
                                    <div className="flex items-center">
                                        <div className="text-2xl w-10 text-center mr-3">{template.icon}</div>
                                        <div>
                                            <span className="font-semibold text-sm text-[var(--tg-theme-text-color)]">{template.name}</span>
                                            <span className="text-xs text-[var(--tg-theme-hint-color)] block">{template.category}</span>
                                        </div>
                                    </div>
                                    <svg className="chevron h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth="3" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" /></svg>
                                </div>
                            ))}
                        </div>
                    </div>
                </StepWrapper>
            );
        }
        
        function Step2({ isVisible, direction, appConfig, setAppConfig, templates }) {
            const currentTemplate = templates.find(t => t.id === appConfig.templateId);
            const initials = (appConfig.appName.split(' ').map(s => s[0]).join('') || '?').substring(0, 2).toUpperCase();

            const handleLogoChange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => setAppConfig(prev => ({...prev, logoDataUrl: event.target.result}));
                    reader.readAsDataURL(file);
                }
            };
            
            const removeLogo = () => {
                setAppConfig(prev => ({...prev, logoDataUrl: null}));
                document.getElementById('logo-upload-input').value = "";
            };

            return (
                <StepWrapper isVisible={isVisible} direction={direction}>
                    <div className="flex flex-col h-full p-5 overflow-y-auto pb-24 scroll-container">
                        <div className="text-center mb-5 shrink-0 animate-in">
                            <h1 className="text-2xl font-bold">Настройки</h1>
                            <p className="text-base text-[var(--tg-theme-hint-color)] mt-1">Шаг 2: Укажите детали</p>
                        </div>
                        <div className="flex justify-center mb-6 shrink-0 animate-in" style={{animationDelay: '0.1s'}}>
                            <div className="mockup-phone">
                                <div className="mockup-screen h-full flex flex-col">
                                    <div className="mockup-header flex items-center space-x-2.5">
                                        <div className="mockup-logo flex-shrink-0">
                                            {appConfig.logoDataUrl ? <img src={appConfig.logoDataUrl} className="w-full h-full object-cover rounded-[9px]" /> : <span>{initials}</span>}
                                        </div>
                                        <span className="mockup-title text-[var(--tg-theme-text-color)] whitespace-nowrap overflow-hidden text-ellipsis">{appConfig.appName || 'Ваше приложение'}</span>
                                    </div>
                                    <div className="mockup-content flex-grow p-3" dangerouslySetInnerHTML={{ __html: currentTemplate?.preview_html || '' }} />
                                </div>
                            </div>
                        </div>
                        <div className="space-y-4">
                            <div className="animate-in" style={{animationDelay: '0.2s'}}>
                                <label htmlFor="app-name" className="font-semibold text-base block mb-1.5">Название</label>
                                <input type="text" id="app-name" value={appConfig.appName} onChange={e => setAppConfig(prev => ({...prev, appName: e.target.value}))} className="w-full p-3 text-sm rounded-xl bg-[var(--tg-theme-secondary-bg-color)] outline-none focus:ring-2 focus:ring-[var(--tg-theme-button-color)]" placeholder="Например, 'Мой Магазин'" />
                            </div>
                            <div className="animate-in" style={{animationDelay: '0.3s'}}>
                                <div className="flex justify-between items-center mb-1.5">
                                    <label className="font-semibold text-base">Логотип</label>
                                    {appConfig.logoDataUrl && <button onClick={removeLogo} className="text-xs text-[var(--tg-theme-link-color)] font-medium">Удалить</button>}
                                </div>
                                <label className="custom-file-upload relative h-32 rounded-xl p-4 text-center cursor-pointer flex items-center justify-center">
                                    {appConfig.logoDataUrl ? <img src={appConfig.logoDataUrl} className="h-full w-auto object-contain rounded-lg" /> : <div className="text-[var(--tg-theme-hint-color)]"><svg className="h-8 w-8 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth="1.5" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M12 16.5V9.75m0 0l-3 3m3-3l3 3M6.75 19.5a4.5 4.5 0 01-1.41-8.775 5.25 5.25 0 0110.233-2.33 3 3 0 013.758 3.848A3.752 3.752 0 0118 19.5H6.75z" /></svg><p className="mt-2 text-xs font-medium">Нажмите для загрузки</p></div>}
                                    <input type="file" id="logo-upload-input" accept="image/png, image/jpeg, image/webp" onChange={handleLogoChange} className="hidden" />
                                </label>
                            </div>
                        </div>
                    </div>
                </StepWrapper>
            );
        }

        function Step3({ isVisible, isDeploying, deployedUrl, error }) {
            const copyUrl = () => {
                navigator.clipboard.writeText(deployedUrl);
                tg.HapticFeedback.impactOccurred('light');
            };

            return (
                <StepWrapper isVisible={isVisible} direction={true}>
                    <div className="flex flex-col h-full items-center justify-center text-center p-6">
                        {isDeploying && <div className="final-container"><svg className="animate-spin h-12 w-12 text-[var(--tg-theme-button-color)] mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><h1 className="text-xl font-bold mt-4">Публикуем...</h1><p className="text-base text-[var(--tg-theme-hint-color)] mt-1">Это может занять до 30 секунд.</p></div>}
                        {deployedUrl && <div className="final-container w-full max-w-sm"><div className="p-3 rounded-full final-icon-bg inline-block mb-3"><svg xmlns="http://www.w3.org/2000/svg" className="h-10 w-10" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path strokeLinecap="round" strokeLinejoin="round" d="M5 13l4 4L19 7" /></svg></div><h1 className="text-2xl font-bold mb-1.5">Приложение опубликовано!</h1><p className="text-[var(--tg-theme-hint-color)] mb-4 text-base">Ваш Mini App доступен по ссылке ниже.</p><div className="url-container flex items-center p-1 rounded-lg"><input value={deployedUrl} type="text" readOnly className="w-full bg-transparent text-sm p-2 text-[var(--tg-theme-text-color)] outline-none" /><button onClick={copyUrl} className="copy-btn rounded-md px-3 py-2 text-sm font-semibold flex-shrink-0">Копировать</button></div><div className="text-left mt-6"><h2 className="font-bold text-base">Как добавить в Telegram:</h2><ol className="list-decimal list-inside text-sm mt-2 space-y-1.5 text-[var(--tg-theme-text-color)]"><li>Откройте <b>@BotFather</b> и отправьте <code className="bg-[var(--tg-theme-secondary-bg-color)] p-1 rounded-md text-xs">/mybots</code>.</li><li>Выберите бота, затем <b>Bot Settings &rarr; Menu Button</b>.</li><li>Нажмите <b>Configure Menu Button</b> и отправьте ссылку.</li><li>Придумайте название для кнопки.</li></ol></div></div>}
                        {error && <div className="final-container w-full max-w-sm"><div className="p-3 rounded-full bg-red-100 text-red-600 inline-block mb-3"><svg xmlns="http://www.w3.org/2000/svg" className="h-10 w-10" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path strokeLinecap="round" strokeLinejoin="round" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></div><h1 className="text-2xl font-bold mb-1.5">Ошибка публикации</h1><p className="text-[var(--tg-theme-hint-color)] text-base">{error}</p></div>}
                    </div>
                </StepWrapper>
            );
        }

        // --- FIX: Use createRoot for React 18 ---
        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);
    </script>
</body>
</html>
